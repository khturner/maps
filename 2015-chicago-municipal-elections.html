<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>
<script src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script>
<style type="text/css">
html, body {
  padding: 0px;
  margin: 0px;
  width: 100%;
  height: 100%;
  font-family: Arial, Helvetica, sans-serif;
}
    
#text-area {
  height: 25%;
  margin: 0px 10px;
}

#text-area p {
  font-size: 16px;
}

#map {
  height: 75%;
}

.precinct-path {
  fill-opacity: 0.75;
  stroke: #000;
  stroke-width: 0.25px;
}

.precinct-path:hover {
  stroke-width: 1.5px;
}

.leaflet-overlay-pane svg path{
  pointer-events: auto;
}

.caption {
  padding: 6px 8px;
  font-size: 14px;
  background: #ddd;
  opacity: 1;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  border-radius: 5px;
}
.caption h4 {
  margin: 0 0 5px;
  color: #777;
}
</style>
</head>
<body>
<div id="text-area">
  <h1>2015 Chicago Municipal Election Results</h1>
  <div class="selection">
      <p>
        <span title="Select a race"><b>Race</b> <select class="dropdown" id="election-select"></select></span>&nbsp;&nbsp;
        <span title="See election results by candidate"><b>Candidate</b> <select class="dropdown" id="candidate-select"><option value="All">All Candidates</option></select></span>
      <p>
  </div>
  <div id="results"><p id="summary-p"></p><p id="results-p"></p></div>

</div>

<div id="map"></div>
<script type="text/javascript">
var candidates,
    results;
    
// define dropdown list and their options
var elections = [
  {district: "city", race: "Mayor"},
  {district: "city", race: "City Clerk"},
  {district: "city", race: "City Treasurer"},
  {district: 1, race: "Alderman 1st Ward"},
  {district: 2, race: "Alderman 2nd Ward"},
  {district: 3, race: "Alderman 3rd Ward"},
  {district: 4, race: "Alderman 4th Ward"},
  {district: 5, race: "Alderman 5th Ward"},
  {district: 6, race: "Alderman 6th Ward"},
  {district: 7, race: "Alderman 7th Ward"},
  {district: 8, race: "Alderman 8th Ward"},
  {district: 9, race: "Alderman 9th Ward"},
  {district: 10, race: "Alderman 10th Ward"},
  {district: 11, race: "Alderman 11th Ward"},
  {district: 12, race: "Alderman 12th Ward"},
  {district: 13, race: "Alderman 13th Ward"},
  {district: 14, race: "Alderman 14th Ward"},
  {district: 15, race: "Alderman 15th Ward"},
  {district: 16, race: "Alderman 16th Ward"},
  {district: 17, race: "Alderman 17th Ward"},
  {district: 18, race: "Alderman 18th Ward"},
  {district: 19, race: "Alderman 19th Ward"},
  {district: 20, race: "Alderman 20th Ward"},
  {district: 21, race: "Alderman 21st Ward"},
  {district: 22, race: "Alderman 22nd Ward"},
  {district: 23, race: "Alderman 23rd Ward"},
  {district: 24, race: "Alderman 24th Ward"},
  {district: 25, race: "Alderman 25th Ward"},
  {district: 26, race: "Alderman 26th Ward"},
  {district: 27, race: "Alderman 27th Ward"},
  {district: 28, race: "Alderman 28th Ward"},
  {district: 29, race: "Alderman 29th Ward"},
  {district: 30, race: "Alderman 30th Ward"},
  {district: 31, race: "Alderman 31st Ward"},
  {district: 32, race: "Alderman 32nd Ward"},
  {district: 33, race: "Alderman 33rd Ward"},
  {district: 34, race: "Alderman 34th Ward"},
  {district: 35, race: "Alderman 35th Ward"},
  {district: 36, race: "Alderman 36th Ward"},
  {district: 37, race: "Alderman 37th Ward"},
  {district: 38, race: "Alderman 38th Ward"},
  {district: 39, race: "Alderman 39th Ward"},
  {district: 40, race: "Alderman 40th Ward"},
  {district: 41, race: "Alderman 41st Ward"},
  {district: 42, race: "Alderman 42nd Ward"},
  {district: 43, race: "Alderman 43rd Ward"},
  {district: 44, race: "Alderman 44th Ward"},
  {district: 45, race: "Alderman 45th Ward"},
  {district: 46, race: "Alderman 46th Ward"},
  {district: 47, race: "Alderman 47th Ward"},
  {district: 48, race: "Alderman 48th Ward"},
  {district: 49, race: "Alderman 49th Ward"},
  {district: 50, race: "Alderman 50th Ward"}
];

var candidateSelect = d3.select("#candidate-select"), // populated after election chosen
    electionSelect = d3.select("#election-select");

electionSelect.selectAll("option")
    .data(elections)
  .enter().append("option")
    .attr("district", d => d.district)
    .attr("file", d => d.race + ".tsv")
    .attr("value", d => d.race)
    .text(d => d.race)

  var defaultElection = "Alderman 33rd Ward"
  electionSelect.property("value", defaultElection);

// initialize map
var map = new L.Map("map", {
    center: [41.87, -87.62],
    zoom: 11
});

map.addLayer(new L.StamenTileLayer("toner"), {
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'
});

var caption = L.control();

caption.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'caption');
    this.update();
    return this._div;
};

caption.update = function (d) {
    this._div.innerHTML = (d ? '<h4>Precinct ' + d.properties.full_text + ' Results</h4><table><thead><tr><th>Candidate</th><th>Votes</th><th>Pct</th></tr></thead>' + results.get(d.properties.full_text).map((d,i) => '<tr><td><font color="' + winnerColor(d.race) + '">' + d.race + "</font></td><td>" + d.votes + "</td><td>" + d.percent + "%</td></tr>").join("") + "</table>"
        : 'Hover over a Precinct');
};

caption.addTo(map);

// add svg overlay to map
L.svg().addTo(map); // render all paths with SVG

var svg = d3.select("#map").select("svg");

// define color scales
var winnerColor = d3.scaleOrdinal(d3.schemeSet1),
    pctColor = d3.scaleQuantile()
    .domain([15, 85]);

// load geospatial boundaries
d3.queue()
    .defer(d3.json, "data/geospatial/precincts.topojson")
    .defer(d3.json, "data/geospatial/wards.topojson")
    .await(ready);

// add event handlers for when new data is selected
function ready(error, precincts, wards) {
  if (error) throw error;

  electionSelect.on("change", function(d) {
      draw(precincts, wards);
    });

  candidateSelect.on("change", updateColors);

  draw(precincts, wards);
}

// draw svg layer + add caption
function draw(precincts, wards) {
  // clear old path and values
  candidates = [];
  results = d3.map();
  d3.selectAll(".precinct-path").remove();
  d3.selectAll(".candidate-option").remove();

  var electionOptions = d3.select("#election-select").node(),
      selectedElection = electionOptions.options[electionOptions.selectedIndex],
      electionDistrict = selectedElection.getAttribute("district"), 
      filePath = "data/election_results/" + selectedElection.getAttribute("file");

  // load election data
  d3.tsv(filePath, parseResults, function(error, electionResults) {
    var transform = d3.geoTransform({point: projectPoint}),
        path = d3.geoPath().projection(transform);

    // if city-wide election chosen, render all precincts
    // otherwise, only renders precincts for relevant ward
    if (electionDistrict == "city") {
      var filteredPrecincts = topojson.feature(precincts, precincts.objects.precincts).features;
    } else {
      var precinctFeatures = topojson.feature(precincts, precincts.objects.precincts),
          filteredPrecincts = precinctFeatures.features.filter(d => d.properties.ward == electionDistrict);
    }

    // populate candidate drop down
    candidateSelect.selectAll("option.candidate-option")
      .data(candidates)
    .enter().append("option")
      .attr("class", "candidate-option")
      .attr("value", d => d)
      .text(d => d)

    // set categorical colors based on candidates
    // only supports up to 10 candidates
    winnerColor.domain(candidates);

    // render precinct choropleth
    var precinctsPath = svg.selectAll("path")
        .data(filteredPrecincts)
      .enter().append("path")
        .attr("class", "precinct-path")
        .attr("id", d => "precinct" + d.properties.full_text)
        .attr("fill", d => winnerColor(results.get(d.properties.full_text)[0].race))
        .on("mouseover", function(d) {
          d3.selectAll("#" + d3.select(this).attr('id'))
              .classed("selected", true);
          caption.update(d);      
        })
        .on("mouseout", function(d) {
          d3.selectAll(".selected")
              .classed("selected", null)
              .classed("unselected", true);
          d3.select("#results-p").html("");
          caption.update(null);
        });

    // center map on feature
    var centroid = d3.geoCentroid({type: "FeatureCollection", "features": filteredPrecincts});

    map.flyTo(new L.LatLng(centroid[1], centroid[0]), electionDistrict == "city" ? 11 : 12);

    // calculate overall results for chosen election
    var flat = [].concat.apply([], results.values());
    var summary = d3.nest()
      .key(d => d.race)
      .rollup(v => d3.sum(v, d => d.votes))
      .object(flat);

    var totalVotes = d3.sum(d3.values(summary));

    d3.select("#summary-p")
      .html("<b>Overall Results:</b><br />" + (d3.entries(summary).sort((a, b) => d3.descending(a.value, b.value)).map(d => "<font color=" + winnerColor(d.key) + ">" + d.key + "</font>: " + d.value + " (" + Math.round(d.value / totalVotes * 10000.0) / 100 + "%)")).join("<br />"));

    map.on("moveend", reset);
    reset();
    
    // reposition SVG on map on zoom/translate
    function reset() {
      precinctsPath.attr("d", path);
    }
  });
}

// see: https://bost.ocks.org/mike/leaflet/
function projectPoint(x, y) {
  var point = map.latLngToLayerPoint(new L.LatLng(y, x));
  this.stream.point(point.x, point.y);
}

// update colors when candidate selected
// when "All" is chosen, categorical color scale shows precinct winners
// when an individual candidate is chosen, discrete sequential color scale shows candidate vote share
function updateColors() {
  var candidate = d3.select("#candidate-select").node().value;

  if (candidate == "All") {
    d3.selectAll(".precinct-path")
        .attr("fill", d => winnerColor(results.get(d.properties.full_text)[0].race))
  } else {
    // create discrete sequential color scale from categorical color corresponding to candidate
    var c = d3.scaleLinear().domain([0,4])
        .interpolate(d3.interpolateHsl)
        .range([
          d3.hsl(winnerColor(candidate)).brighter(1.5),
          d3.hsl(winnerColor(candidate)).darker(3)
        ]);

    pctColor.range([...Array(5).keys()].map(x => c(x)));

    d3.selectAll(".precinct-path")
        .attr("fill", d => pctColor(results.get(d.properties.full_text).find(x => x.race == candidate).percent))
  }
}

// parse election result data file
function parseResults(d, i) {
  if (!i) for (var k in d) {
    if (/^votes\|/.test(k)) {
      var p = k.split("|");
      candidates.push(p[1]);
    }
  }

  results.set(d.Precinct, candidates.map(c => { return {race: c, votes: +d["votes|"+c], percent: +d["pct|"+c]}; }).sort((a,b) => b.votes - a.votes));
}
</script>
</body>
</html>